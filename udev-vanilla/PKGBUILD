# Maintainer: Dave Reisner <d@falconindy.com>

pkgname=udev-vanilla
_pkgname=udev
pkgdesc="The userspace dev tools (udev). Less annoying Arch junk."
pkgver=168
pkgrel=2
arch=('i686' 'x86_64')
url="http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html"
license=('GPL')
depends=('libusb-compat' 'glib2' 'module-init-tools>=3.11' 'pciutils')
conflicts=('udev')
provides=("udev=$pkgver")
options=(!libtool)
makedepends=('pciutils' 'libusb-compat' 'glib2' 'gperf' 'libxslt' 'gobject-introspection')
backup=(etc/udev/udev.conf etc/modprobe.d/framebuffer_blacklist.conf)
install=udev.install
source=(http://www.kernel.org/pub/linux/utils/kernel/hotplug/$_pkgname-$pkgver.tar.bz2
        81-arch.rules)
md5sums=('4a466078532ab5dd5c35acc3ea2ec9a1'
         '72242dad9de6ed88faee459519ee7d53')

build() {
  cd "$srcdir/$_pkgname-$pkgver"

  ./configure --sysconfdir=/etc \
              --with-rootlibdir=/lib \
              --libexecdir=/lib/udev \
              --sbindir=/sbin \
              --with-systemdsystemunitdir=/lib/systemd/system
  make
}

package() {
  cd "$srcdir/$_pkgname-$pkgver"

  make DESTDIR="$pkgdir" install

  # fix file conflict in bluez
  rm -f "$pkgdir/lib/udev/hid2hci"

  # Install arch rules for grouping/perms
  install -D -m644 "$srcdir/81-arch.rules" "$pkgdir/lib/udev/rules.d/81-arch.rules"

  # create framebuffer blacklist
  mkdir -p "$pkgdir/etc/modprobe.d/"
  mapfile -t modules < <(find /lib/modules/*/kernel/drivers/video -name '*fb.ko.gz' -exec basename {} .ko.gz \; | sort -u)
  (( ${#modules[*]} )) && printf 'blacklist %s\n' "${modules[@]}" > "$pkgdir/etc/modprobe.d/framebuffer_blacklist.conf"

  # create static devices in /lib/udev/devices/
  mkdir "$pkgdir"/lib/udev/devices/pts "$pkgdir"/lib/udev/devices/shm

  mknod -m 0600 "$pkgdir/lib/udev/devices/console" c 5 1
  mknod -m 0666 "$pkgdir/lib/udev/devices/null" c 1 3
  mknod -m 0660 "$pkgdir/lib/udev/devices/zero" c 1 5
  mknod -m 0666 "$pkgdir/lib/udev/devices/kmsg" c 1 11

  ln -snf /proc/self/fd   "$pkgdir/lib/udev/devices/fd"
  ln -snf /proc/self/fd/0 "$pkgdir/lib/udev/devices/stdin"
  ln -snf /proc/self/fd/1 "$pkgdir/lib/udev/devices/stdout"
  ln -snf /proc/self/fd/2 "$pkgdir/lib/udev/devices/stderr"
  ln -snf /proc/kcore     "$pkgdir/lib/udev/devices/core"

  # these static devices are created for convenience, to autoload the modules
  # if necessary /dev/loop0
  mknod -m 0660 "$pkgdir/lib/udev/devices/loop0" b 7 0
  chgrp disk "$pkgdir/lib/udev/devices/loop0"

  # Replace dialout/tape/cdrom group in rules with uucp/storage/optical group
  sed -i 's#GROUP="dialout"#GROUP="uucp"#g;
          s#GROUP="tape"#GROUP="storage"#g;
          s#GROUP="cdrom"#GROUP="optical"#g' "$pkgdir"/lib/udev/rules.d/*.rules
}

